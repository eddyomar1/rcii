<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Actividad Diaria de RCII</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-aqua flex items-center justify-center min-h-screen p-4">
  <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-4">Actividad Diaria de RCII</h1>

    <!-- Usuario + Checkin/Checkout -->
    <div class="mb-4">
      <input id="userId" type="text" placeholder="ID de usuario"
             class="w-full p-2 border rounded mb-2" />
      <button id="checkInBtn"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded mb-2">
        Registrar Entrada
      </button>
      <button id="checkOutBtn"
              class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded">
        Registrar Salida
      </button>
    </div>

    <!-- Lista de Actividades + Trabajo Realizado -->
    <div class="mb-4">
      <select id="activitySelect"
              class="w-full p-2 border rounded mb-2">
        <option value="">Selecciona una actividad</option>
        <!-- ...tus opciones... -->
      </select>
      <textarea id="trabajoRealizado"
                placeholder="Describe el trabajo realizado…"
                class="w-full p-2 border rounded mb-2"
                rows="2"></textarea>
      <button id="addActivityBtn"
              class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded">
        Registrar Actividad
      </button>
    </div>

    <!-- Filtro por Fecha -->
    <div class="mb-4">
      <label for="dateFilter" class="block mb-1">Filtrar por fecha:</label>
      <input id="dateFilter" type="date"
             class="w-full p-2 border rounded mb-2" />
      <button id="filterBtn"
              class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded mb-2">
        Filtrar por Fecha
      </button>
      <button id="clearFilterBtn"
              class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded">
        Mostrar Todas
      </button>
    </div>

    <!-- Historial -->
    <h2 class="text-lg font-semibold mb-2">Historial</h2>
    <ul id="activityLog"
        class="border p-4 rounded max-h-64 overflow-y-auto text-sm"></ul>
  </div>

  <script>
    // Referencias DOM
    const userIdInput      = document.getElementById('userId');
    const checkInBtn       = document.getElementById('checkInBtn');
    const checkOutBtn      = document.getElementById('checkOutBtn');
    const activitySelect   = document.getElementById('activitySelect');
    const trabajoTextarea  = document.getElementById('trabajoRealizado');
    const addActivityBtn   = document.getElementById('addActivityBtn');
    const dateFilter       = document.getElementById('dateFilter');
    const filterBtn        = document.getElementById('filterBtn');
    const clearFilterBtn   = document.getElementById('clearFilterBtn');
    const activityLog      = document.getElementById('activityLog');

    // Carga inicial
    fetchActivities();

    // Fetch de actividades
    async function fetchActivities(fecha = '') {
      const url = fecha
        ? `api.php?action=get&date=${encodeURIComponent(fecha)}`
        : `api.php?action=get`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(res.statusText);
        const actividades = await res.json();
        activityLog.innerHTML = actividades.length
          ? actividades.map(a => `
              <li class="py-1">
                ${a.formatted_timestamp} — ${a.activity_type}
                ${a.trabajo_realizado ? `: ${a.trabajo_realizado}` : ''}
                <span class="text-gray-500"> (Usuario: ${a.user_id})</span>
              </li>
            `).join('')
          : `<li class="py-1 text-gray-500">No hay actividades.</li>`;
      } catch (e) {
        console.error(e);
        alert('Error al cargar actividades');
      }
    }

    // Loguear actividades (entrada, salida o personalizada)
    async function logActivity(activityType) {
      const user_id           = userIdInput.value.trim();
      const trabajo_realizado = trabajoTextarea.value.trim();
      if (!user_id) {
        return alert('Por favor, ingresa un ID de usuario.');
      }
      const payload = { user_id, activity_type: activityType, trabajo_realizado };
      try {
        const res = await fetch('api.php?action=add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(res.statusText);
        trabajoTextarea.value = '';         // limpiamos textarea
        fetchActivities(dateFilter.value);  // recargamos historial
      } catch (e) {
        console.error(e);
        alert('Error al registrar la actividad');
      }
    }

    // Eventos
    checkInBtn.addEventListener('click', () => logActivity('Entrada'));
    checkOutBtn.addEventListener('click', () => logActivity('Salida'));
    addActivityBtn.addEventListener('click', () => {
      const sel = activitySelect.value;
      if (!sel) return alert('Por favor, selecciona una actividad.');
      logActivity(sel);
    });
    filterBtn.addEventListener('click', () => {
      if (!dateFilter.value) return alert('Por favor, selecciona una fecha.');
      fetchActivities(dateFilter.value);
    });
    clearFilterBtn.addEventListener('click', () => {
      dateFilter.value = '';
      fetchActivities();
    });
  </script>
</body>
</html>
